<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>게시판 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- AWS SDK -->
    <script src="assets/js/aws/aws-cognito-sdk.min.js"></script>
    <!-- Amazon Cognito Identity SDK -->
    <script src="assets/js/aws/amazon-cognito-identity.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1236.0.min.js"></script>
    <script src="assets/js/auth.js"></script>

</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">게시판 관리</h1>

        <!-- 게시판 목록 -->
        <h3>게시판 목록</h3>
        <button class="btn btn-primary mb-3" id="loadBoardsBtn">게시판 목록 불러오기</button>
        <ul id="boardList" class="list-group mb-5"></ul>

        <!-- 게시글 작성 -->
        <h3>게시글 작성</h3>
        <form id="createPostForm">
            <div class="mb-3">
                <label for="boardType" class="form-label">게시판 종류</label>
                <select class="form-select" id="boardType">
                    <option value="notice">공지사항</option>
                    <option value="general">일반게시판</option>
                    <option value="qna">Q&A</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="postTitle" class="form-label">제목</label>
                <input type="text" class="form-control" id="postTitle" required>
            </div>
            <div class="mb-3">
                <label for="postContent" class="form-label">내용</label>
                <textarea class="form-control" id="postContent" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">게시글 작성</button>
        </form>

        <!-- 게시글 목록 -->
        <h3 class="mt-5">게시글 목록</h3>
        <div class="mb-3">
            <label for="selectedBoard" class="form-label">게시판 선택</label>
            <select class="form-select" id="selectedBoard">
                <option value="notice">공지사항</option>
                <option value="general">일반게시판</option>
                <option value="qna">Q&A</option>
            </select>
        </div>
        <button class="btn btn-primary mb-3" id="loadPostsBtn">게시글 목록 불러오기</button>
        <ul id="postList" class="list-group mb-5"></ul>

        <!-- 댓글 추가 -->
        <h3>댓글 작성</h3>
        <form id="createReplyForm">
            <div class="mb-3">
                <label for="postId" class="form-label">게시글 ID</label>
                <input type="text" class="form-control" id="postId" required>
            </div>
            <div class="mb-3">
                <label for="replyContent" class="form-label">댓글 내용</label>
                <textarea class="form-control" id="replyContent" rows="2" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">댓글 작성</button>
        </form>
    </div>

    <script>
        const apiUrl = 'https://{your-api-id}.execute-api.{region}.amazonaws.com/{stage}'; // API Gateway URL 변경

        // 게시판 목록 불러오기
        document.getElementById('loadBoardsBtn').addEventListener('click', async () => {
            const response = await fetch(`${apiUrl}/boards`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            const boards = await response.json();
            const boardList = document.getElementById('boardList');
            boardList.innerHTML = '';
            boards.forEach(board => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = `${board.boardType} - ${board.boardName}`;
                boardList.appendChild(listItem);
            });
        });

        // 게시글 작성
        document.getElementById('createPostForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const boardType = document.getElementById('boardType').value;
            const postTitle = document.getElementById('postTitle').value;
            const postContent = document.getElementById('postContent').value;



            // 로컬스토리지에서 accessToken 가져오기 (Cognito에서 로그인 후 저장된 토큰)
            const accessToken = localStorage.getItem('accessToken');
            if (!accessToken) {
                alert('로그인이 필요합니다.');
                return;
            }

            const response = await fetch(`${apiUrl}/post/${boardType}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`, // Cognito JWT를 Authorization 헤더에 포함
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: postTitle, content: postContent })
            });

            if (response.ok) {
                alert('게시글이 성공적으로 작성되었습니다.');
                document.getElementById('createPostForm').reset();
            } else {
                alert('게시글 작성에 실패했습니다.');
            }
        });

        // 게시글 목록 불러오기
        document.getElementById('loadPostsBtn').addEventListener('click', async () => {
            const selectedBoard = document.getElementById('selectedBoard').value;

            const response = await fetch(`${apiUrl}/posts/${selectedBoard}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const posts = await response.json();
            const postList = document.getElementById('postList');
            postList.innerHTML = '';
            posts.forEach(post => {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item';
                listItem.textContent = `${post.postId} - ${post.title}`;
                postList.appendChild(listItem);
            });
        });

        // 댓글 작성
        document.getElementById('createReplyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = document.getElementById('postId').value;
            const replyContent = document.getElementById('replyContent').value;

             // 로컬스토리지에서 accessToken 가져오기 (Cognito에서 로그인 후 저장된 토큰)
             const accessToken = localStorage.getItem('accessToken');
             if (!accessToken) {
                 alert('로그인이 필요합니다.');
                 return;
             }

            const response = await fetch(`${apiUrl}/reply/${postId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`, // Cognito JWT를 Authorization 헤더에 포함
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: replyContent })
            });

            if (response.ok) {
                alert('댓글이 성공적으로 작성되었습니다.');
                document.getElementById('createReplyForm').reset();
            } else {
                alert('댓글 작성에 실패했습니다.');
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
